<!DOCTYPE html>
<html lang="en">
<head>
  <title>Matt's Music</title>
  <link rel="stylesheet" type="text/css" href="/style.css">
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
  <script type="text/babel">

    const parseJSON = (xhr, content) => {
        const { response = false } = xhr;
        if (response) {
            const obj = JSON.parse(xhr.response);
            console.dir(obj);
            
            if(obj.message) {
                /*
              const p = document.createElement('p');
              p.textContent = `Message: ${obj.message}`;
              content.appendChild(p);
              */
            }
            
            if(obj.entries) {
              const entryList = document.querySelector('#list');
              const listNode = document.createElement('li');
              const key = Object.keys(obj.entries)[0];
              let entries = `<a href='${obj.entries[key].link}'>`;
              entries = `${entries}${obj.entries[key].name}</a>`;
              entries = `${entries}<p>${obj.entries[key].desc}</p>`;
              entries = `${entries}<p>Genre: ${obj.entries[key].genre}</p>`;
              listNode.innerHTML = entries;
              entryList.appendChild(listNode);
            }
        }
    };

    const displayUsers = () => {
        
    };

    const handleResponse = (xhr) => {
      const content = document.querySelector('#content');
      /*
      switch(xhr.status) {
        case 200: //success
          content.innerHTML = `<b>Success</b>`;
          break;
        case 201: //created
          content.innerHTML = '<b>Create</b>';
          break;
        case 204: //updated (no response back from server)
          content.innerHTML = '<b>Updated (No Content)</b>';
          return;
        case 400: //bad request
          content.innerHTML = `<b>Bad Request</b>`;
          break;
        case 404: //not found
          content.innerHTML = `<b>Page not found</b>`;
          break;
        default: //any other status code
          content.innerHTML = `Error code not implemented by client.`;
          break;
      }
      */
      parseJSON(xhr, content);
    };

    const sendPost = (e, nameForm) => {
      e.preventDefault();
      
      const nameAction = nameForm.getAttribute('action');
      const nameMethod = nameForm.getAttribute('method');
        
      const nameField = nameForm.querySelector('#nameField');
      const linkField = nameForm.querySelector('#linkField');
      const descField = nameForm.querySelector('#descField');
      const genreField = nameForm.querySelector('#genreField');
      
      const xhr = new XMLHttpRequest();
      xhr.open(nameMethod, nameAction);
      
      xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
      xhr.setRequestHeader ('Accept', 'application/json');
      
      xhr.onload = () => handleResponse(xhr);
        
      let descFormat = "";
      if(descField.value)
          descFormat = `${descField.value}`;
      
      const formData = `name=${nameField.value}&link=${linkField.value}&desc=${descFormat}&genre=${genreField.value}`;
      
      xhr.send(formData);
        
      sendAjax(e);
    
      return false;
    };

    const sendAjax = (e) => {
      e.preventDefault();
      const xhr = new XMLHttpRequest();
      xhr.open('GET', '/getEntries');
        
      xhr.setRequestHeader ("Accept", 'application/json');

      xhr.onload = () => handleResponse(xhr);

      xhr.send();
        return false;
    }

    const init = () => {
      const nameForm = document.querySelector('#nameForm');
      const userForm = document.querySelector('#userForm');
      const urlField = document.querySelector('#urlField');
      const methodSelect = document.querySelector('#methodSelect');
      
      const addEntry = (e) => sendPost(e, nameForm);
      const getUser = (e) => sendAjax(e);
      
      nameForm.addEventListener('submit', addEntry);
      userForm.addEventListener('submit', getUser);
    };

    window.onload = init;

  </script>
</head>
<body>
  <section id="top">
    <h3>Matt Hoffman Music Archive</h3>
    <form id="nameForm" action="/addEntry" method="post">
      <label for="link">Link: </label>
      <input id="linkField" type="text" name="link" />
      <label for="name">Name: </label>
      <input id="nameField" type="text" name="name" />
      <label for="desc">Description: </label>
      <input id="descField" type="text" name="desc"/>
      <label for="genre">Genre: </label>
      <select id='genreField' name="genre">
        <option value='game'>Game music</option>
        <option value='electronic'>Electronic</option>
        <option value='eurobeat'>Eurobeat</option>
      </select>
      <input type="submit" value="Add User" />
    </form>
    <form id="userForm" action="/getEntries" method="get">
      <input type="submit" value="Get User" />
    </form>
  </section>
  <section id="content">
      <h3>Songs</h3>
      <ul id="list">
      
      </ul>
  </section>
</body>
</html>